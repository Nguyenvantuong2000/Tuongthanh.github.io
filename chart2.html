<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bi·ªÉu ƒë·ªì d·ªØ li·ªáu th·ªùi ti·∫øt</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: url(bautroi1.jpg);
        margin: 0;
        padding: 20px;
        text-align: center;
      }

      #chart-container {
        width: 95%;
        max-width: 1200px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2);
      }

      button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        background: #007bff;
        color: white;
        cursor: pointer;
        margin-bottom: 20px;
      }

      button:hover {
        background: #0066d6;
      }
    </style>
  </head>

  <body>
    <h2>BI·ªÇU ƒê·ªí D·ªÆ LI·ªÜU TH√îNG S·ªê TR·∫†M 2</h2>

    <button onclick="window.location.href = 'index.html'">‚¨Ö Quay l·∫°i</button>

    <div id="chart-container">
      <canvas id="weatherChart"></canvas>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBBsYxtBersbD1YbLktbx9q7BNfBvm6kDI",
        authDomain: "iot-app-daf56.firebaseapp.com",
        databaseURL: "https://iot-app-daf56-default-rtdb.firebaseio.com",
        projectId: "iot-app-daf56",
        storageBucket: "iot-app-daf56.firebasestorage.app",
        messagingSenderId: "457044759856",
        appId: "1:457044759856:web:cef945f5afb641ec7464f5",
        measurementId: "G-XJ24FHPJH4",
      };

      firebase.initializeApp(firebaseConfig);

      const ctx = document.getElementById("weatherChart").getContext("2d");

      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [], // Th·ªùi gian
          datasets: [
            {
              label: "Nhi·ªát ƒë·ªô (¬∞C)",
              data: [],
              borderWidth: 2,
              borderColor: "red",
            },
            {
              label: "ƒê·ªô ·∫©m (%)",
              data: [],
              borderWidth: 2,
              borderColor: "blue",
            },
            {
              label: "Tia UV",
              data: [],
              borderWidth: 2,
              borderColor: "purple",
            },
            {
              label: "L∆∞·ª£ng m∆∞a",
              data: [],
              borderWidth: 2,
              borderColor: "green",
            },
            {
              label: "T·ªëc ƒë·ªô gi√≥",
              data: [],
              borderWidth: 2,
              borderColor: "orange",
            },
            { label: "CO", data: [], borderWidth: 2, borderColor: "brown" },
            {
              label: "B·ª•i m·ªãn",
              data: [],
              borderWidth: 2,
              borderColor: "black",
            },
            { label: "ƒê·ªô ·ªìn", data: [], borderWidth: 2, borderColor: "pink" },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: {
              title: { display: true, text: "Th·ªùi gian" },
            },
            y: {
              title: { display: true, text: "Gi√° tr·ªã ƒëo" },
            },
          },
        },
      });

      // ===================================
      // üîÑ L·∫§Y D·ªÆ LI·ªÜU T·ª™ FIREBASE (slave2)
      // ===================================
      const dbRef = firebase.database().ref("slave2");

      dbRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        let timeLabel = "";

        // ====== Tr∆∞·ªùng h·ª£p last_update l√† UNIX timestamp ======
        if (typeof data.last_update === "number") {
          const date = new Date(data.last_update * 1000);
          timeLabel =
            date.toLocaleTimeString("vi-VN") +
            " " +
            date.toLocaleDateString("vi-VN");
        }

        // ====== Tr∆∞·ªùng h·ª£p last_update l√† chu·ªói "2025-12-12 21:12:30" ======
        else if (typeof data.last_update === "string") {
          timeLabel = data.last_update;
        }

        // Kh√¥ng c√≥ last_update ‚Üí b·ªè qua
        else {
          return;
        }

        // ==== Th√™m th·ªùi gian v√†o bi·ªÉu ƒë·ªì ====
        chart.data.labels.push(timeLabel);

        // ==== Th√™m gi√° tr·ªã v√†o dataset ====
        chart.data.datasets[0].data.push(data.temp);
        chart.data.datasets[1].data.push(data.hum);
        chart.data.datasets[2].data.push(data.uv);
        chart.data.datasets[3].data.push(data.rain);
        chart.data.datasets[4].data.push(data.wind);
        chart.data.datasets[5].data.push(data.co);
        chart.data.datasets[6].data.push(data.dust);
        chart.data.datasets[7].data.push(data.noise);

        // Gi·ªõi h·∫°n t·ªëi ƒëa 50 ƒëi·ªÉm
        if (chart.data.labels.length > 50) {
          chart.data.labels.shift();
          chart.data.datasets.forEach((ds) => ds.data.shift());
        }

        chart.update();
      });
    </script>
  </body>
</html>
