<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: url(bautroi1.jpg);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .form-box {
        background: white;
        padding: 25px;
        border-radius: 15px;
        width: 350px;
        text-align: center;
        box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2);
      }

      .form-box input {
        width: 90%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 15px;
      }

      button {
        width: 95%;
        padding: 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background: #0066d6;
      }

      a {
        color: #007bff;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <!-- ====================== FORM ƒêƒÇNG NH·∫¨P ====================== -->
    <div id="login-form" class="form-box">
      <h2>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>

      <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" />
      <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" />

      <button onclick="dangNhap()">ƒêƒÉng nh·∫≠p</button>

      <p id="login-error" style="color: red; margin-top: 10px"></p>

      <p style="margin-top: 10px">
        Ch∆∞a c√≥ t√†i kho·∫£n? <a onclick="showRegister()">ƒêƒÉng k√Ω</a>
      </p>
    </div>

    <!-- ====================== FORM ƒêƒÇNG K√ù ====================== -->
    <div id="register-form" class="form-box" style="display: none">
      <h2>ƒêƒÉng k√Ω t√†i kho·∫£n</h2>

      <input type="text" id="reg-username" placeholder="T√™n ƒëƒÉng nh·∫≠p" />
      <input type="password" id="reg-password" placeholder="M·∫≠t kh·∫©u" />

      <button onclick="dangKy()">T·∫°o t√†i kho·∫£n</button>

      <p id="reg-error" style="color: red; margin-top: 10px"></p>

      <p style="margin-top: 10px">
        ƒê√£ c√≥ t√†i kho·∫£n? <a onclick="showLogin()">ƒêƒÉng nh·∫≠p</a>
      </p>
    </div>

    <script>
      // function login() {
      //  sessionStorage.setItem("logged", "true");
      ////  window.location.href = "main.html";
      // }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      // =========================
      // üí† KH·ªûI T·∫†O FIREBASE
      // =========================
      const firebaseConfig = {
        apiKey: "AIzaSyBBsYxtBersbD1YbLktbx9q7BNfBvm6kDI",
        authDomain: "iot-app-daf56.firebaseapp.com",
        databaseURL: "https://iot-app-daf56-default-rtdb.firebaseio.com",
        projectId: "iot-app-daf56",
        storageBucket: "iot-app-daf56.firebasestorage.app",
        messagingSenderId: "457044759856",
        appId: "1:457044759856:web:cef945f5afb641ec7464f5",
        measurementId: "G-XJ24FHPJH4",
      };

      firebase.initializeApp(firebaseConfig);

      // =========================
      // üîÑ CHUY·ªÇN FORM
      // =========================
      function showRegister() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("register-form").style.display = "block";
      }

      function showLogin() {
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-form").style.display = "block";
      }

      // =========================
      // üü¶ ƒêƒÇNG K√ù ‚Üí l∆∞u v√†o user/<username>
      // =========================
      function dangKy() {
        const user = document.getElementById("reg-username").value.trim();
        const pass = document.getElementById("reg-password").value.trim();
        const error = document.getElementById("reg-error");
        error.innerText = "";

        if (user === "" || pass === "") {
          error.innerText = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!";
          return;
        }

        firebase
          .database()
          .ref("user/" + user)
          .once("value")
          .then((snap) => {
            if (snap.exists()) {
              error.innerText = "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!";
              return;
            }

            // ‚ûï L∆ØU USER M·ªöI
            return firebase
              .database()
              .ref("user/" + user)
              .set({
                password: pass,
                role: "guest",
                createdAt: new Date().toISOString(),
              });
          })
          .then(() => {
            alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
            showLogin();
          })
          .catch(() => {
            error.innerText = "L·ªói k·∫øt n·ªëi Firebase!";
          });
      }

      // =========================
      // üü© ƒêƒÇNG NH·∫¨P
      // =========================
      function dangNhap() {
        const user = document.getElementById("username").value.trim();
        const pass = document.getElementById("password").value.trim();
        const error = document.getElementById("login-error");
        error.innerText = "";

        if (!user || !pass) {
          error.innerText = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!";
          return;
        }

        firebase
          .database()
          .ref("user/" + user)
          .once("value")
          .then((snapshot) => {
            if (!snapshot.exists()) {
              error.innerText = "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!";
              return;
            }

            const data = snapshot.val();

            // üîë SO S√ÅNH ƒê√öNG
            if (String(data.password).trim() !== pass.trim()) {
              error.innerText = "Sai m·∫≠t kh·∫©u!";
              return;
            }

            // ‚úÖ ƒêƒÇNG NH·∫¨P TH√ÄNH C√îNG
            localStorage.setItem("logged", "true");
            localStorage.setItem("username", user);
            localStorage.setItem("role", data.role || "guest");

            window.location.replace("index.html");
          })
          .catch((err) => {
            console.error(err);
            error.innerText = "L·ªói k·∫øt n·ªëi Firebase!";
          });
      }
    </script>
  </body>
</html>
